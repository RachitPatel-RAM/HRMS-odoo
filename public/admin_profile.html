<!DOCTYPE html>
<html class="" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Admin Profile - HRMS</title>
    <link href="/css/output.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Gochi+Hand&amp;family=Spline+Sans:wght@400;600&amp;display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: "#9C27B0", // Purple accent
                        secondary: "#7B61FF",
                        "paper-white": "#FFFFFF",
                    },
                    fontFamily: {
                        hand: ["'Gochi Hand'", "cursive"],
                        display: ["'Gochi Hand'", "cursive"],
                    },
                    boxShadow: {
                        sketch: "4px 4px 0px 0px rgba(0,0,0,1)",
                        "sketch-sm": "2px 2px 0px 0px rgba(0,0,0,1)",
                        hand: "4px 4px 0px 0px rgba(0,0,0,1)",
                    }
                }
            }
        };
    </script>
</head>

<body class="bg-white text-gray-900 font-display min-h-screen flex flex-col selection:bg-purple-200">
    <header
        class="sticky top-0 z-50 bg-white border-b-2 border-black px-6 py-2 flex justify-between items-center shadow-md relative">
        <!-- Left: Logo -->
        <div class="flex items-center gap-3">
            <div class="flex items-center justify-center p-1">
                <img src="/assets/logg_odooHRMS.png" alt="Odoo Logo" class="h-20 w-20 object-contain">
            </div>
            <!-- <span class="text-2xl font-bold tracking-tight">Odoo HRMS</span> -->
        </div>

        <!-- Center: Navigation -->
        <nav class="hidden md:flex items-center gap-6 absolute left-1/2 transform -translate-x-1/2">
            <a href="/admin-dashboard.html"
                class="bg-white text-black px-6 py-2 text-xl font-bold border-2 border-black transform -rotate-1 shadow-[2px_3px_0px_0px_rgba(0,0,0,1)] hover:-translate-y-1 hover:bg-gray-50 transition-all rounded-sm font-hand">
                Employees
            </a>
            <a href="/admin_attendance.html"
                class="bg-white text-black px-6 py-2 text-xl font-bold border-2 border-black transform rotate-1 shadow-[2px_3px_0px_0px_rgba(0,0,0,1)] hover:-translate-y-1 hover:bg-gray-50 transition-all rounded-sm font-hand">
                Attendance
            </a>
            <a href="/admin_timeoff.html"
                class="bg-white text-black px-6 py-2 text-xl font-bold border-2 border-black transform -rotate-1 shadow-[2px_3px_0px_0px_rgba(0,0,0,1)] hover:-translate-y-1 hover:bg-gray-50 transition-all rounded-sm font-hand">
                Time Off
            </a>
            <a href="/admin_hr_management.html" id="nav-hr-management"
                class="bg-white text-black px-6 py-2 text-xl font-bold border-2 border-black transform rotate-1 shadow-[2px_3px_0px_0px_rgba(0,0,0,1)] hover:-translate-y-1 hover:bg-gray-50 transition-all rounded-sm font-hand">
                HR Management
            </a>
        </nav>

        <!-- Right: Avatar -->
        <div class="hidden md:flex items-center gap-4">
            <button class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                <span class="material-icons-outlined text-2xl">notifications</span>
            </button>
            <div class="relative group">
                <button
                    class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden border-2 border-black focus:outline-none focus:ring-2 focus:ring-primary">
                    <img id="navAvatar" alt="User Avatar" class="w-full h-full object-cover"
                        src="https://ui-avatars.com/api/?name=Admin&background=random" />
                </button>
                <div
                    class="absolute right-0 mt-2 w-48 bg-white border-2 border-black rounded-md shadow-hand opacity-0 group-hover:opacity-100 invisible group-hover:visible transition-all transform origin-top-right z-50">
                    <a class="block px-4 py-2 text-lg hover:bg-purple-100" href="/admin_profile.html">My Profile</a>
                    <a id="logoutBtn" class="block px-4 py-2 text-lg hover:bg-purple-100 text-red-600" href="#">Log
                        Out</a>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow flex items-center justify-center p-4">
        <div
            class="bg-white border-2 border-black rounded-lg p-12 shadow-sketch text-center max-w-lg w-full transform rotate-1 hover:rotate-0 transition-transform duration-300">
            <div class="relative inline-block mb-6">
                <div class="w-40 h-40 rounded-full border-4 border-black overflow-hidden bg-gray-100 mx-auto shadow-sm">
                    <img id="profileImage" alt="Profile Picture" class="w-full h-full object-cover"
                        src="https://ui-avatars.com/api/?name=Super+Admin&background=random&size=256" />
                </div>
                <!-- Upload Button Badge -->
                <label for="profileImageInput"
                    class="absolute bottom-2 right-2 bg-primary text-white p-2 rounded-full border-2 border-black cursor-pointer hover:bg-purple-700 transition-colors">
                    <span class="material-icons-outlined text-xl">photo_camera</span>
                </label>
                <input type="file" id="profileImageInput" accept="image/*" class="hidden" />
            </div>

            <h1 class="text-4xl font-bold font-hand mb-2 text-black" id="userName">Loading...</h1>
            <p class="text-xl text-gray-600 font-display mb-6" id="userRole">...</p>

            <div class="space-y-3 text-left bg-gray-50 p-6 rounded border-2 border-black/10">
                <div class="flex items-center gap-3">
                    <span class="material-icons-outlined text-gray-500">email</span>
                    <span class="font-bold text-lg" id="adminEmail">admin@hrms.com</span>
                </div>
                <div class="flex items-center gap-3">
                    <span class="material-icons-outlined text-gray-500">badge</span>
                    <span class="font-bold text-lg" id="userId">ID: Loading...</span>
                </div>
                <div class="flex items-center gap-3">
                    <span class="material-icons-outlined text-gray-500">admin_panel_settings</span>
                    <span class="font-bold text-lg text-primary" id="userAccess">Loading...</span>
                </div>
            </div>

            <div class="mt-8">
                <button id="logoutBtnMain"
                    class="bg-red-500 text-white px-8 py-3 text-xl font-bold border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:bg-red-600 hover:shadow-none hover:translate-x-[2px] hover:translate-y-[2px] transition-all rounded-sm flex items-center justify-center gap-2 mx-auto w-full">
                    <span class="material-icons-outlined">logout</span> Log Out
                </button>
            </div>
        </div>
    </main>

    <footer class="text-center py-6 text-gray-500 text-lg border-t-2 border-black mt-auto bg-white">
        Â© 2026 odoo HRMS - All Right Reserved.
    </footer>

    <script>
        const API_BASE = '/api';

        async function fetchProfile() {
            const token = localStorage.getItem('token');
            if (!token) return window.location.href = '/login.html';

            try {
                const res = await fetch(`${API_BASE}/dashboard`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.status === 401 || res.status === 403) {
                    window.location.href = '/login.html';
                    return;
                }

                const data = await res.json();
                const user = data.me;

                if (user) {
                    // Update profile info
                    const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'User';
                    document.getElementById('userName').innerText = fullName;
                    document.getElementById('adminEmail').innerText = user.email || 'N/A';
                    document.getElementById('userId').innerText = `ID: ${user.employeeId || user.id || 'N/A'}`;

                    // Role-specific display
                    if (user.role === 'ADMIN') {
                        document.getElementById('userRole').innerText = 'System Administrator';
                        document.getElementById('userAccess').innerText = 'Full Access';
                    } else if (user.role === 'HR') {
                        document.getElementById('userRole').innerText = 'HR Manager';
                        document.getElementById('userAccess').innerText = 'HR Access';
                        // Hide HR Management menu for HR users
                        const hrLink = document.getElementById('nav-hr-management');
                        if (hrLink) hrLink.style.display = 'none';
                    } else {
                        document.getElementById('userRole').innerText = user.role || 'Employee';
                        document.getElementById('userAccess').innerText = 'Limited Access';
                    }

                    // Update images
                    const profilePic = user.profile_picture || `https://ui-avatars.com/api/?name=${encodeURIComponent(fullName)}`;
                    document.getElementById('profileImage').src = profilePic;
                    const navAvatar = document.getElementById('navAvatar');
                    if (navAvatar) navAvatar.src = profilePic;
                }

            } catch (err) {
                console.error(err);
                window.location.href = '/login.html';
            }
        }

        // Initial Load
        fetchProfile();

        // Profile Image Upload Handler
        document.getElementById('profileImageInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Image size must be less than 5MB');
                return;
            }

            const formData = new FormData();
            formData.append('avatar', file); // Changed from 'profile_picture' to 'avatar'

            const token = localStorage.getItem('token');

            try {
                const res = await fetch(`${API_BASE}/profile/avatar`, { // Changed from /picture to /avatar
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                if (res.ok) {
                    const data = await res.json();
                    // Update images immediately
                    if (data.url) {
                        document.getElementById('profileImage').src = data.url;
                        const navAvatar = document.getElementById('navAvatar');
                        if (navAvatar) navAvatar.src = data.url;
                        alert('Profile picture updated successfully!');
                    }
                } else {
                    const error = await res.json().catch(() => ({ message: 'Failed to upload image' }));
                    alert(error.message || 'Failed to upload image');
                }
            } catch (err) {
                console.error(err);
                alert('Error uploading image');
            }
        });

        // Logout Logic
        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        }

        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) logoutBtn.addEventListener('click', logout);

        const logoutBtnMain = document.getElementById('logoutBtnMain');
        if (logoutBtnMain) logoutBtnMain.addEventListener('click', logout);

    </script>
</body>

</html>